<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jurnal Trading Cerdas (Advanced)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #1a3b5d;
            padding-bottom: 80px; /* Space for bottom nav */
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.05), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            transition: all 0.3s ease-in-out;
        }
        .positive-profit { color: #16a34a; }
        .negative-profit { color: #dc2626; }
        .chart-container { position: relative; width: 100%; height: 350px; }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3b82f6;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; backdrop-filter: blur(4px);
        }
        .modal-content {
            background-color: white; padding: 2rem; border-radius: 0.75rem;
            max-width: 550px; width: 90%; position: relative;
            box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
        }
        .modal-close {
            position: absolute; top: 1rem; right: 1rem; cursor: pointer;
            font-size: 1.5rem; line-height: 1; color: #9ca3af;
        }
        .modal-close:hover { color: #1a3b5d; }
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background-color: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex; justify-content: space-around;
            padding: 0.5rem 0;
            z-index: 999;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            color: #6b7280; font-size: 0.75rem;
            padding: 0.25rem 0.5rem; border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            width: 20%;
        }
        .nav-item.active { color: #3b82f6; background-color: #eff6ff; }
        .nav-item svg { width: 24px; height: 24px; margin-bottom: 0.25rem; }
        .fab-container {
            position: fixed;
            bottom: 90px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            z-index: 1000;
        }
        .fab {
            background-color: #106cde; color: white;
            width: 60px; height: 60px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 14px rgba(0,0,0,0.25);
            cursor: pointer; transition: transform 0.2s;
        }
        .fab:hover { transform: scale(1.1); }
        .fab.education-fab { background-color: #16a34a; }
        .impact-High { color: #dc2626; }
        .impact-Medium { color: #f59e0b; }
        .impact-Low { color: #fbbf24; }
    </style>
</head>
<body class="antialiased">

    <!-- Auth Screen -->
    <div id="auth-screen" class="min-h-screen flex flex-col items-center justify-center bg-gray-100">
        <h1 class="text-4xl font-black text-blue-600 mb-4">Selamat Datang!</h1>
        <p class="text-gray-600 mb-8">Login untuk mengakses Jurnal Trading Cerdas Anda.</p>
        <button id="login-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
            <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21.99,12.03c0-0.83-0.07-1.62-0.21-2.38h-9.78v4.51h5.5c-0.24,1.48-0.99,2.73-2.13,3.58v2.96h3.8c2.22-2.04,3.5-5.17,3.5-8.67Z" fill="#4285F4"></path><path d="M12,22c2.72,0,5.01-0.9,6.68-2.44l-3.8-2.96c-0.9,0.6-2.07,0.96-3.48,0.96-2.64,0-4.88-1.78-5.68-4.22H2.99v3.06C4.7,20.06,8.08,22,12,22Z" fill="#34A853"></path><path d="M6.32,13.74c-0.15-0.45-0.24-0.93-0.24-1.44s0.09-0.99,0.24-1.44V7.81H2.99C2.37,9.05,2,10.47,2,12s0.37,2.95,0.99,4.19L6.32,13.74Z" fill="#FBBC05"></path><path d="M12,5.28c1.47,0,2.79,0.52,3.83,1.5l3.38-3.38C17.01,1.52,14.72,0,12,0,8.08,0,4.7,1.94,2.99,4.75L6.32,7.81C7.12,5.36,9.36,5.28,12,5.28Z" fill="#EA4335"></path></svg>
            Login dengan Google
        </button>
    </div>

    <!-- Main App Content -->
    <div id="app-content" class="container mx-auto p-4 md:p-8 hidden">
        <div class="flex justify-between items-center mb-8">
            <h2 id="active-account-name" class="text-2xl font-bold">Pilih Akun</h2>
            <div id="user-info" class="flex items-center gap-2">
                <img id="user-photo" class="w-8 h-8 rounded-full">
                <button id="logout-btn" class="text-sm text-gray-500 hover:text-red-500">Logout</button>
            </div>
        </div>

        <!-- VIEWS -->
        <div id="jurnal-view" class="view">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                 <div id="trade-form-card" class="card">
                     <h2 id="form-title" class="text-2xl font-bold mb-4">Catat Trade Baru</h2>
                     <form id="trade-form" class="space-y-4">
                         <input type="hidden" id="trade-id">
                         <datalist id="pair-list"></datalist>
                         <datalist id="strategy-list"></datalist>
                         <div class="grid grid-cols-2 gap-4">
                             <div>
                                 <label for="pair" class="block text-sm font-medium">Pair</label>
                                 <input type="text" id="pair" list="pair-list" placeholder="cth: EUR/USD" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                             </div>
                             <div>
                                 <label for="lot-size" class="block text-sm font-medium">Lot Size</label>
                                 <input type="number" id="lot-size" step="0.01" placeholder="cth: 0.01" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                             </div>
                         </div>
                         <div>
                             <label for="strategy" class="block text-sm font-medium">Setup / Strategi</label>
                             <input type="text" id="strategy" list="strategy-list" placeholder="cth: Breakout H1" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                         </div>
                         <div class="grid grid-cols-2 gap-4">
                              <div>
                                 <label for="position" class="block text-sm font-medium">Posisi</label>
                                 <select id="position" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                     <option value="buy">Buy</option>
                                     <option value="sell">Sell</option>
                                 </select>
                             </div>
                              <div>
                                 <label for="profit-loss" class="block text-sm font-medium">P/L</label>
                                 <input type="number" step="any" id="profit-loss" placeholder="cth: 50 atau -25" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                             </div>
                         </div>
                         <div>
                             <label for="notes" class="block text-sm font-medium">Catatan / Kesalahan</label>
                             <textarea id="notes" rows="3" placeholder="cth: Entry terlalu cepat, FOMO" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                         </div>
                         <div class="flex gap-2">
                             <button type="submit" id="submit-btn" class="flex-grow bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Simpan Trade</button>
                             <button type="button" id="cancel-edit-btn" class="hidden flex-grow bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">Batal</button>
                         </div>
                     </form>
                 </div>
                 <div class="card">
                     <h2 class="text-2xl font-bold mb-4 flex justify-between items-center">
                         <span>Riwayat Trade</span>
                         <div class="space-x-2">
                             <button id="import-btn" class="text-sm bg-gray-200 text-gray-700 font-semibold py-1 px-3 rounded-lg hover:bg-gray-300">Impor</button>
                             <button id="export-btn" class="text-sm bg-gray-200 text-gray-700 font-semibold py-1 px-3 rounded-lg hover:bg-gray-300">Ekspor</button>
                         </div>
                     </h2>
                     <div class="overflow-x-auto max-h-[450px]">
                         <table class="w-full text-sm text-left">
                             <thead class="text-xs uppercase bg-gray-700 text-white sticky top-0">
                                 <tr>
                                     <th class="px-4 py-3">Tanggal</th>
                                     <th class="px-4 py-3">Pair</th>
                                     <th class="px-4 py-3">Posisi</th>
                                     <th class="px-4 py-3">P/L</th>
                                     <th class="px-4 py-3 text-center">Aksi</th>
                                 </tr>
                             </thead>
                             <tbody id="trade-log-body"></tbody>
                         </table>
                     </div>
                 </div>
            </div>
        </div>
        
           <div id="pasar-view" class="view hidden">
            <!-- TradingView Widget BEGIN -->
                <div class="tradingview-widget-container">
                <div class="tradingview-widget-container__widget"></div>
                <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js" async>
                {
                "symbols": [
                    {
                    "description": "",
                    "proName": "OANDA:XAUUSD"
                    },
                    {
                    "description": "",
                    "proName": "BITSTAMP:BTCUSD"
                    },
                    {
                    "description": "",
                    "proName": "CMCMARKETS:EURUSD"
                    },
                    {
                    "description": "",
                    "proName": "CMCMARKETS:EURJPY"
                    },
                    {
                    "description": "",
                    "proName": "CMCMARKETS:USDJPY"
                    },
                    {
                    "description": "",
                    "proName": "FX:GBPUSD"
                    },
                    {
                    "description": "",
                    "proName": "CMCMARKETS:GBPJPY"
                    }
                ],
                "showSymbolLogo": true,
                "isTransparent": false,
                "displayMode": "adaptive",
                "colorTheme": "light",
                "locale": "en"
                }
                </script>
                </div>
                <!-- TradingView Widget END -->
           <div class="card">
               <h2 class="text-2xl font-bold mb-4">Watchlist Pasar</h2>
               <!-- TradingView Widget BEGIN -->
               <div class="tradingview-widget-container">
                 <div id="tradingview-widget"></div>
                 <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
                 <script type="text/javascript">
                   window.addEventListener('DOMContentLoaded', function() {
                     if (typeof TradingView !== 'undefined') {
                       const pairs = [
                         { proName: "OANDA:XAUUSD", title: "XAU/USD" },
                         { proName: "FOREXCOM:SPXUSD", title: "S&P 500" },
                         { proName: "FOREXCOM:NSXUSD", title: "Nasdaq 100" },
                         { proName: "FX:EURUSD", title: "EUR/USD" },
                         { proName: "FX:GBPUSD", title: "GBP/USD" },
                         { proName: "FX_IDC:USDJPY", title: "USD/JPY" },
                       ];

                       const dropdown = document.createElement('select');
                       dropdown.className = "mb-4 p-2 border rounded-md shadow-sm w-full";
                       pairs.forEach((pair, idx) => {
                         const option = document.createElement('option');
                         option.value = idx;
                         option.textContent = pair.title || pair.proName;
                         dropdown.appendChild(option);
                       });
                       const container = document.getElementById('tradingview-widget').parentElement;
                       container.insertBefore(dropdown, document.getElementById('tradingview-widget'));

                       function renderWidget(pair) {
                         document.getElementById('tradingview-widget').innerHTML = "";
                         new TradingView.widget({
                           "container_id": "tradingview-widget",
                           "symbol": pair.proName,
                           "showSymbolLogo": true,
                           "colorTheme": "light",
                           "isTransparent": false,
                           "displayMode": "adaptive",
                           "locale": "id",
                           "width": "100%",
                           "height": 400
                         });
                       }
                       renderWidget(pairs[0]);
                       dropdown.addEventListener('change', function() {
                         renderWidget(pairs[this.value]);
                       });
                     }
                   });
                 </script>
               </div>
               <!-- TradingView Widget END -->

            <div class="flex flex-col md:flex-row gap-4"></div>
                <!-- Technical Analysis Widget (Left) -->
                <div class="tradingview-widget-container flex-1 min-w-0">
                    <div class="tradingview-widget-container__widget"></div>
                    <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-technical-analysis.js" async>
                    {
                        "interval": "1m",
                        "width": "100%",
                        "isTransparent": false,
                        "height": "550",
                        "symbol": "OANDA:XAUUSD",
                        "showIntervalTabs": true,
                        "displayMode": "single",
                        "locale": "en",
                        "colorTheme": "light"
                    }
                    </script>
                </div>
                <!-- Events Widget (Right) -->
                <div class="tradingview-widget-container flex-1 min-w-0">
                    <div class="tradingview-widget-container__widget"></div>
                    <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-events.js" async>
                    {
                        "colorTheme": "light",
                        "isTransparent": false,
                        "width": "100%",
                        "height": "550",
                        "locale": "en",
                        "importanceFilter": "-1,0,1",
                        "countryFilter": "us"
                    }
                    </script>
                </div>
            </div>
       </div>


        <div id="analisa-view" class="view hidden">
            <section id="dashboard" class="mb-8">
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 md:gap-6 text-center">
                    <div class="card">
                        <h3 class="text-md font-bold text-gray-500">Saldo Akun</h3>
                        <p id="balance" class="text-3xl font-extrabold mt-2">$0.00</p>
                    </div>
                    <div class="card">
                        <h3 class="text-md font-bold text-gray-500">Total P/L</h3>
                        <p id="total-pl" class="text-3xl font-extrabold mt-2">$0.00</p>
                    </div>
                    <div class="card">
                        <h3 class="text-md font-bold text-gray-500">Keuntungan %</h3>
                        <p id="profit-percentage" class="text-3xl font-extrabold mt-2">0.0%</p>
                    </div>
                    <div class="card">
                        <h3 class="text-md font-bold text-gray-500">Win Rate</h3>
                        <p id="win-rate" class="text-3xl font-extrabold mt-2">0%</p>
                    </div>
                    <div class="card">
                        <h3 class="text-md font-bold text-gray-500">Total Trades</h3>
                        <p id="total-trades" class="text-3xl font-extrabold mt-2">0</p>
                    </div>
                </div>
            </section>
             <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                 <div class="card lg:col-span-2">
                     <h2 class="text-2xl font-bold mb-4">Kurva Ekuitas</h2>
                     <div class="chart-container">
                         <canvas id="equity-curve-chart"></canvas>
                     </div>
                 </div>
                  <div class="card">
                     <h2 class="text-2xl font-bold mb-4">Performa per Pair</h2>
                      <div class="chart-container">
                         <canvas id="pair-performance-chart"></canvas>
                     </div>
                 </div>
                  <div class="card">
                     <h2 class="text-2xl font-bold mb-4">Performa per Strategi</h2>
                      <div class="chart-container">
                         <canvas id="strategy-performance-chart"></canvas>
                     </div>
                 </div>
                  <div class="card lg:col-span-2">
                     <h2 class="text-2xl font-bold mb-4">Analisis Performa AI</h2>
                     <div id="analysis-content" class="space-y-4 text-sm max-h-[350px] overflow-y-auto"></div>
                 </div>
            </div>
        </div>

        <div id="akun-view" class="view hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="card">
                    <h2 class="text-2xl font-bold mb-4">Buat Akun Baru</h2>
                    <form id="account-form" class="space-y-4">
                        <div>
                           <label for="account-name" class="block text-sm font-medium">Nama Akun</label>
                           <input type="text" id="account-name" placeholder="cth: Akun Prop Firm" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="start-balance" class="block text-sm font-medium">Saldo Awal</label>
                                <input type="number" id="start-balance" value="1000" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="currency-type" class="block text-sm font-medium">Tipe Mata Uang</label>
                                <select id="currency-type" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="cent">Cent</option>
                                    <option value="USD">USD</option>
                                </select>
                            </div>
                        </div>
                         <button type="submit" id="create-account-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Buat Akun</button>
                    </form>
                </div>
                <div class="card">
                     <h2 class="text-2xl font-bold mb-4">Daftar Akun Anda</h2>
                     <div id="accounts-list" class="space-y-3 max-h-[300px] overflow-y-auto"></div>
                </div>
                 <div class="md:col-span-2 card">
                    <h2 class="text-2xl font-bold mb-4">Kalkulator Risiko AI</h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                             <div>
                                <label for="risk-percent" class="block text-sm font-medium">Risiko (%)</label>
                                <input type="number" id="risk-percent" value="2" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                            </div>
                             <div>
                                <label for="stop-loss" class="block text-sm font-medium">Stop Loss (pips)</label>
                                <input type="number" id="stop-loss" value="20" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                            </div>
                        </div>
                        <button id="calculate-risk-btn" class="w-full bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600">Hitung Lot Size</button>
                        <div id="risk-result" class="text-center p-4 bg-gray-50 rounded-lg mt-4 hidden">
                           <p class="text-sm text-gray-600">Rekomendasi Total Lot Size:</p>
                           <p id="lot-size-result" class="text-2xl font-bold text-blue-600"></p>
                           <p class="text-xs text-gray-500 mt-1">Estimasi Risiko: <span id="risk-amount-result"></span></p>
                           <button id="ai-recommendation-btn" class="mt-2 text-sm text-blue-600 hover:underline">Dapatkan Rekomendasi & Cek Kewajaran dari AI</button>
                           <div id="ai-recommendation-result" class="text-left text-xs mt-2 p-2 bg-blue-50 border-blue-200 rounded-md"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="news-view" class="view hidden">
            <div class="card">
                <h2 class="text-2xl font-bold mb-4">Berita & Analisis Pasar AI</h2>
                <div class="space-y-4 md:flex md:space-y-0 md:space-x-4 md:items-end mb-6">
                    <div class="flex-grow">
                        <label for="watched-pairs" class="block text-sm font-medium">Fokus Pair (pisahkan dengan koma)</label>
                        <input type="text" id="watched-pairs" placeholder="EUR/USD, GBP/JPY, XAU/USD" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <button id="ai-news-btn" class="w-full md:w-auto bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600">Dapatkan Outlook AI</button>
                </div>
                <div id="ai-news-result" class="p-4 bg-blue-50 border border-blue-200 rounded-md mb-6 min-h-[50px]">
                    <p class="text-gray-500">Outlook dari AI akan muncul di sini...</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-xl font-bold mb-2">Kalender Ekonomi (Forex Factory)</h3>
                        <div id="forex-factory-calendar" class="space-y-2 max-h-[400px] overflow-y-auto">
                            <div class="loader"></div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold mb-2">Berita Umum Pasar</h3>
                        <div id="news-list" class="space-y-4 max-h-[400px] overflow-y-auto">
                            <div class="loader"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Bottom Navigation -->
    <nav id="bottom-nav" class="bottom-nav hidden">
        <button data-view="jurnal-view" class="nav-item active">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>
            Jurnal
        </button>
        <button data-view="pasar-view" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>
            Pasar
        </button>
        <button data-view="analisa-view" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 006 16.5h12A2.25 2.25 0 0020.25 14.25V3.75M3.75 18.75h16.5M12 12.75h.008v.008H12v-.008z" /></svg>
            Analisa
        </button>
         <button data-view="news-view" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5h1.5m-1.5 3h1.5m-7.5 3h7.5m-7.5 3h7.5m3-9h3.375c.621 0 1.125.504 1.125 1.125V18a2.25 2.25 0 01-2.25 2.25M16.5 7.5V18a2.25 2.25 0 002.25 2.25M16.5 7.5V4.875c0-.621-.504-1.125-1.125-1.125H4.125C3.504 3.75 3 4.254 3 4.875V18a2.25 2.25 0 002.25 2.25h13.5M6 7.5h3v3H6v-3z" /></svg>
            Berita
        </button>
        <button data-view="akun-view" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            Akun
        </button>
    </nav>
    
    <div class="fab-container hidden">
        <button id="education-fab" class="fab education-fab" title="Panduan Aplikasi">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
        </button>
        <button id="donation-fab" class="fab" title="Donasi untuk Nabhan">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path d="M10 3.5a1.5 1.5 0 013 0V4a1 1 0 001 1h1a1 1 0 011 1v3.5a1.5 1.5 0 01-3 0V9.5a.5.5 0 00-.5-.5h-1a.5.5 0 00-.5.5v.5a.5.5 0 01-.5.5h-1a.5.5 0 01-.5-.5v-1a.5.5 0 00-.5-.5H9a.5.5 0 00-.5.5v1a.5.5 0 01-.5.5H7a.5.5 0 01-.5-.5V9.5a.5.5 0 00-.5-.5h-1a.5.5 0 00-.5.5v.5a1.5 1.5 0 01-3 0V6a1 1 0 011-1h1a1 1 0 001-1V3.5z" /><path d="M5.5 11a3.5 3.5 0 11-1 3.337V16.5a.5.5 0 00.5.5h2a.5.5 0 00.5-.5v-2.163A3.5 3.5 0 015.5 11zm9 0a3.5 3.5 0 11-1 3.337V16.5a.5.5 0 00.5.5h2a.5.5 0 00.5-.5v-2.163A3.5 3.5 0 0114.5 11z" /></svg>
        </button>
    </div>
    
    <!-- Modals -->
    <div id="mindset-modal" class="modal-overlay hidden"><div class="modal-content"><span class="modal-close-btn modal-close">&times;</span><h2 class="text-2xl font-bold mb-4">✨ Analisis Mindset AI</h2><div id="mindset-modal-body"></div></div></div>
    <div id="donation-modal" class="modal-overlay hidden"><div class="modal-content text-center"><span class="modal-close-btn modal-close">&times;</span><h2 class="text-2xl font-bold mb-4">Donasi untuk Kreator</h2><p class="mb-4 text-gray-600">Terima kasih telah menggunakan aplikasi ini. Dukung Nabhan melalui BCA.</p><div class="p-4 bg-blue-50 rounded-lg"><p class="font-semibold text-lg">Bank Central Asia (BCA)</p><p class="text-2xl font-bold text-blue-600 my-2">6695673021</p><p class="font-semibold">a/n Nabhan Yuzqi Al Mubarok</p></div></div></div>

    <div id="education-modal" class="modal-overlay hidden">
        <div class="modal-content text-left">
            <span class="modal-close-btn modal-close">&times;</span>
            <h2 class="text-2xl font-bold mb-4">Panduan Aplikasi Jurnal Trading</h2>
            <div class="text-sm space-y-3 max-h-[60vh] overflow-y-auto pr-2">
            <p><strong>1. Halaman Akun:</strong> Buat akun trading pertama Anda. Bisa untuk akun USD maupun Cent — sistem menghitung lot size dengan rumus yang sama karena nilai uang setara (contoh: 1000 USD = 100.000 cent).</p>
            <p><strong>2. Kalkulator Risiko:</strong> Tersedia di halaman 'Akun'. Tentukan lot size yang aman sesuai risiko dan stop loss. Kalkulator memperhitungkan mata uang akun secara otomatis.</p>
            <p><strong>3. Halaman Jurnal:</strong> Setelah memilih akun aktif, catat setiap trade Anda di sini. Gunakan dropdown untuk mempercepat input Pair dan Strategi.</p>
            <p><strong>4. Halaman Analisa:</strong> Lihat performa trading Anda: kurva ekuitas, win rate, dan analisis AI.</p>
            <p><strong>5. Halaman Watchlist Pasar:</strong> Pantau pergerakan harga melalui grafik interaktif dari TradingView dan Investing.com (dua sumber tersedia untuk kenyamanan dan kelengkapan).</p>
            <p><strong>6. Halaman Berita:</strong> Dapatkan berita pasar. Jika berita dari MyFxBook/Forex Factory gagal dimuat (karena keterbatasan sumber), silakan kunjungi langsung situs tersebut atau pantau berita lewat grafik live di halaman Pasar.</p>
            </div>
        </div>
    </div>


    <div id="import-modal" class="modal-overlay hidden"><div class="modal-content text-center"><span class="modal-close-btn modal-close">&times;</span><h2 class="text-2xl font-bold mb-4">Impor Riwayat Trade</h2><p class="mb-4 text-gray-600">Unggah file CSV dari MetaTrader atau gunakan template kami.</p><input type="file" id="csv-file-input" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 mb-4"/><button id="process-import-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 mb-4">Proses Impor</button><a id="download-template-btn" href="#" class="text-sm text-blue-600 hover:underline">Download Template CSV</a><div id="import-status" class="mt-4 text-sm"></div></div></div>
    <div id="withdrawal-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <span class="modal-close-btn modal-close">&times;</span>
            <h2 class="text-2xl font-bold mb-4">Catat Penarikan Dana</h2>
            <form id="withdrawal-form" class="space-y-4">
                <div>
                    <label for="withdrawal-amount" class="block text-sm font-medium">Jumlah Penarikan</label>
                    <input type="number" id="withdrawal-amount" placeholder="cth: 100" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">Simpan Penarikan</button>
            </form>
        </div>
    </div>

    <footer class="text-center mt-12 py-4">
        <p class="text-sm text-gray-500">Dibuat dengan ❤️ oleh Nabhan</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy, serverTimestamp, updateDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAk8WhrmqYHmWvcLP5kWh9Fpskbk-7UwU8",
            authDomain: "jurnal-trading-ai.firebaseapp.com",
            projectId: "jurnal-trading-ai",
            storageBucket: "jurnal-trading-ai.firebasestorage.app",
            messagingSenderId: "436443442605",
            appId: "1:436443442605:web:3dae7a44032d63b0e0c524",
            measurementId: "G-SQ9SZEKKWZ"
        };
        const geminiApiKey = "AIzaSyCXl-bqMtYmp4AuKEdLz1yDl0mzVmVIJXk";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let equityChart, pairChart, strategyChart;
        let activeAccountId = null;
        let allAccounts = [];
        let allTrades = []; // This will include trades and withdrawals
        let tradeListenerUnsubscribe = null;
        let accountListenerUnsubscribe = null;
        let newsCache = [];

        const ui = {
            authScreen: document.getElementById('auth-screen'),
            appContent: document.getElementById('app-content'),
            loginBtn: document.getElementById('login-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            bottomNav: document.getElementById('bottom-nav'),
            fabContainer: document.querySelector('.fab-container'),
            views: document.querySelectorAll('.view'),
            navItems: document.querySelectorAll('.nav-item'),
            activeAccountName: document.getElementById('active-account-name'),
            userInfo: document.getElementById('user-info'),
            userPhoto: document.getElementById('user-photo'),
            accountForm: document.getElementById('account-form'),
            accountsList: document.getElementById('accounts-list'),
            tradeForm: document.getElementById('trade-form'),
            pairDataList: document.getElementById('pair-list'),
            strategyDataList: document.getElementById('strategy-list'),
            donationModal: document.getElementById('donation-modal'),
            educationModal: document.getElementById('education-modal'),
            importModal: document.getElementById('import-modal'),
            withdrawalModal: document.getElementById('withdrawal-modal'),
            withdrawalForm: document.getElementById('withdrawal-form'),
            newsList: document.getElementById('news-list'),
            forexFactoryCalendar: document.getElementById('forex-factory-calendar'),
            aiNewsBtn: document.getElementById('ai-news-btn'),
            aiNewsResult: document.getElementById('ai-news-result')
        };
        
        function initializeCharts() {
            // Equity Chart
            const equityCtx = document.getElementById('equity-curve-chart').getContext('2d');
            if (equityChart) equityChart.destroy();
            const gradient = equityCtx.createLinearGradient(0, 0, 0, 350);
            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.2)');
            gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');
            equityChart = new Chart(equityCtx, {
                type: 'line',
                data: { datasets: [{ label: 'Saldo', data: [], borderColor: '#3b82f6', backgroundColor: gradient, fill: true, tension: 0.2, pointRadius: 0, pointHitRadius: 10 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'day' } }, y: { title: { display: true, text: 'Saldo Akun' } } }, plugins: { legend: { display: false } } }
            });

            // Pair Performance Chart
            const pairCtx = document.getElementById('pair-performance-chart').getContext('2d');
            if(pairChart) pairChart.destroy();
            pairChart = new Chart(pairCtx, {
                type: 'doughnut',
                data: { labels: [], datasets: [{ data: [], backgroundColor: ['#16a34a', '#dc2626'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } }
            });

            // Strategy Performance Chart
            const strategyCtx = document.getElementById('strategy-performance-chart').getContext('2d');
            if(strategyChart) strategyChart.destroy();
            strategyChart = new Chart(strategyCtx, {
                type: 'bar',
                data: { labels: [], datasets: [{ label: 'Total P/L', data: [], backgroundColor: [] }] },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }
        
        // --- AUTH ---
        ui.loginBtn.addEventListener('click', () => signInWithPopup(auth, provider).catch(error => console.error("Login Gagal:", error)));
        ui.logoutBtn.addEventListener('click', () => signOut(auth).catch(error => console.error("Logout Gagal:", error)));

        onAuthStateChanged(auth, user => {
            if (user) {
                ui.authScreen.classList.add('hidden');
                ui.appContent.classList.remove('hidden');
                ui.bottomNav.classList.remove('hidden');
                ui.fabContainer.classList.remove('hidden');
                ui.userPhoto.src = user.photoURL;
                initAppForUser(user);
            } else {
                ui.authScreen.classList.remove('hidden');
                ui.appContent.classList.add('hidden');
                ui.bottomNav.classList.add('hidden');
                ui.fabContainer.classList.add('hidden');
                if (tradeListenerUnsubscribe) tradeListenerUnsubscribe();
                if (accountListenerUnsubscribe) accountListenerUnsubscribe();
            }
        });

        // --- UI & NAVIGATION ---
        ui.bottomNav.addEventListener('click', (e) => {
            const navItem = e.target.closest('.nav-item');
            if (!navItem) return;
            const viewId = navItem.dataset.view;
            ui.views.forEach(view => view.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            ui.navItems.forEach(item => item.classList.remove('active'));
            navItem.classList.add('active');
            if(viewId === 'news-view' && newsCache.length === 0) {
                fetchNews();
                fetchForexFactoryNews();
            }
        });

        function initAppForUser(user) {
            listenForAccounts(user.uid);
            ui.accountForm.addEventListener('submit', (e) => handleAccountForm(e, user.uid));
            ui.tradeForm.addEventListener('submit', handleTradeFormSubmit);
            document.getElementById('import-btn').addEventListener('click', () => ui.importModal.classList.remove('hidden'));
            document.getElementById('export-btn').addEventListener('click', exportToCSV);
            ui.withdrawalForm.addEventListener('submit', handleWithdrawalSubmit);
        }
        
        // --- ACCOUNT MANAGEMENT ---
        function listenForAccounts(userId) {
            const accountsRef = collection(db, 'users', userId, 'accounts');
            if (accountListenerUnsubscribe) accountListenerUnsubscribe();
            accountListenerUnsubscribe = onSnapshot(query(accountsRef, orderBy('name')), snapshot => {
                allAccounts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAccountsList(userId);
                
                if (activeAccountId && !allAccounts.some(acc => acc.id === activeAccountId)) {
                    activeAccountId = null;
                }

                const storedAccountId = localStorage.getItem(`activeAccountId_${userId}`);
                const accountExists = allAccounts.some(acc => acc.id === storedAccountId);

                if (accountExists) {
                     if (activeAccountId !== storedAccountId) setActiveAccount(storedAccountId, userId);
                } else if (allAccounts.length > 0 && !activeAccountId) {
                    setActiveAccount(allAccounts[0].id, userId);
                } else if (allAccounts.length === 0) {
                    clearDisplay();
                }
            }, (error) => { console.error("Error listening for accounts:", error) });
        }
        
        async function handleAccountForm(e, userId) {
             e.preventDefault();
             const btn = document.getElementById('create-account-btn');
             btn.disabled = true;
             btn.textContent = 'Membuat...';
             const newAccount = {
                 name: document.getElementById('account-name').value,
                 startBalance: parseFloat(document.getElementById('start-balance').value),
                 currency: document.getElementById('currency-type').value
             };
             try {
                 await addDoc(collection(db, 'users', userId, 'accounts'), newAccount);
                 ui.accountForm.reset();
             } catch(error) { console.error("Error creating account:", error); }
             finally { btn.disabled = false; btn.textContent = 'Buat Akun'; }
        }

        function setActiveAccount(accountId, userId) {
            activeAccountId = accountId;
            localStorage.setItem(`activeAccountId_${userId}`, accountId);
            renderAccountsList(userId);
            const activeAccount = allAccounts.find(acc => acc.id === accountId);
            if(activeAccount) {
                ui.activeAccountName.textContent = activeAccount.name;
                listenForTrades();
            }
        }

        async function deleteAccount(userId, accountId) {
            // Using a custom modal instead of confirm
            if (!await showConfirmation('Apakah Anda yakin ingin menghapus akun ini beserta SEMUA trade di dalamnya? Tindakan ini tidak dapat diurungkan.')) return;
            
            try {
                const tradesRef = collection(db, 'users', userId, 'accounts', accountId, 'trades');
                const tradesSnapshot = await getDocs(tradesRef);
                const batch = writeBatch(db);
                tradesSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                await deleteDoc(doc(db, 'users', userId, 'accounts', accountId));
                
                if(activeAccountId === accountId) {
                    activeAccountId = null;
                    localStorage.removeItem(`activeAccountId_${userId}`);
                }
            } catch (error) {
                console.error("Error deleting account and its trades:", error);
                showAlert("Gagal menghapus akun.");
            }
        }

        function renderAccountsList(userId) {
            ui.accountsList.innerHTML = '';
            if (allAccounts.length === 0) {
                ui.accountsList.innerHTML = '<p class="text-gray-500 text-sm">Anda belum memiliki akun. Silakan buat satu.</p>';
                return;
            }
            allAccounts.forEach(acc => {
                const isActive = acc.id === activeAccountId;
                const accDiv = document.createElement('div');
                accDiv.className = `p-3 rounded-lg flex justify-between items-center ${isActive ? 'bg-blue-100 border border-blue-400' : 'bg-gray-100'}`;
                
                let buttonsHtml = `
                    <button class="delete-account-btn text-red-500 hover:text-red-700 p-2" data-account-id="${acc.id}" title="Hapus Akun">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                    </button>
                `;

                if (isActive) {
                    buttonsHtml = `
                        <button class="withdraw-btn text-green-600 hover:text-green-800 p-2" data-account-id="${acc.id}" title="Tarik Dana">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z" /><path fill-rule="evenodd" d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm3 0a1 1 0 011-1h1a1 1 0 110 2H8a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                        </button>
                    ` + buttonsHtml;
                }

                accDiv.innerHTML = `
                    <div class="cursor-pointer flex-grow" data-account-id="${acc.id}">
                        <p class="font-bold">${acc.name}</p>
                        <p class="text-sm text-gray-500">Saldo Awal: ${acc.startBalance} ${acc.currency}</p>
                    </div>
                    <div class="flex items-center">
                        ${buttonsHtml}
                    </div>
                `;
                accDiv.querySelector('.flex-grow').addEventListener('click', () => setActiveAccount(acc.id, userId));
                if (isActive) {
                    accDiv.querySelector('.withdraw-btn').addEventListener('click', () => openWithdrawalModal(acc.id));
                }
                accDiv.querySelector('.delete-account-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteAccount(userId, acc.id)
                });
                ui.accountsList.appendChild(accDiv);
            });
        }

        function clearDisplay() {
            ui.activeAccountName.textContent = "Buat Akun Baru";
            allTrades = [];
            updateDashboard();
            updateChart();
            renderTrades();
            document.getElementById('analysis-content').innerHTML = '<p class="text-gray-500">Silakan pilih atau buat akun untuk memulai.</p>';
        }

        // --- TRADE & WITHDRAWAL MANAGEMENT ---
        function listenForTrades() {
            if (!activeAccountId || !auth.currentUser) return;
            if (tradeListenerUnsubscribe) tradeListenerUnsubscribe();
            
            const tradesRef = collection(db, 'users', auth.currentUser.uid, 'accounts', activeAccountId, 'trades');
            const q = query(tradesRef, orderBy("createdAt", "asc"));

            tradeListenerUnsubscribe = onSnapshot(q, snapshot => {
                allTrades = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateAllUI();
            });
        }
        
        function updateAllUI() {
             renderTrades();
             updateDashboard();
             updateChart();
             renderPairPerformanceChart();
             renderStrategyPerformanceChart();
             generateOverallAnalysis();
             updatePairAndStrategyDataLists();
        }

        function updatePairAndStrategyDataLists() {
            const actualTrades = allTrades.filter(t => t.pair !== 'WITHDRAWAL');
            const defaultPairs = ["EUR/USD", "GBP/USD", "USD/JPY", "AUD/USD", "USD/CAD", "USD/CHF", "XAU/USD", "BTC/USD"];
            const userPairs = actualTrades.map(trade => trade.pair);
            const uniquePairs = [...new Set([...defaultPairs, ...userPairs])].sort();
            ui.pairDataList.innerHTML = uniquePairs.map(p => `<option value="${p}"></option>`).join('');

            const defaultStrategies = ["Supply and Demand", "Breakout", "Trend Following", "Scalping", "Swing Trading", "Fibonacci Retracement", "Smart Money Concept"];
            const userStrategies = actualTrades.map(trade => trade.strategy);
            const uniqueStrategies = [...new Set([...defaultStrategies, ...userStrategies])].sort();
            ui.strategyDataList.innerHTML = uniqueStrategies.map(s => `<option value="${s}"></option>`).join('');
        }

        async function handleTradeFormSubmit(e) {
            e.preventDefault();
            if (!activeAccountId) {
                showAlert("Pilih atau buat akun terlebih dahulu!");
                return;
            }
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;

            const tradeId = document.getElementById('trade-id').value;
            const tradeData = {
                pair: document.getElementById('pair').value.toUpperCase(),
                lotSize: parseFloat(document.getElementById('lot-size').value),
                strategy: document.getElementById('strategy').value,
                position: document.getElementById('position').value,
                pl: parseFloat(document.getElementById('profit-loss').value),
                notes: document.getElementById('notes').value,
            };

            const tradesPath = `users/${auth.currentUser.uid}/accounts/${activeAccountId}/trades`;

            try {
                if (tradeId) {
                    submitBtn.textContent = 'Mengupdate...';
                    await updateDoc(doc(db, tradesPath, tradeId), tradeData);
                } else {
                    submitBtn.textContent = 'Menyimpan...';
                    tradeData.createdAt = serverTimestamp();
                    await addDoc(collection(db, tradesPath), tradeData);
                }
            } catch (error) { console.error("Error saving trade:", error); }
            finally { submitBtn.disabled = false; resetTradeForm(); }
        }
        
        function resetTradeForm() {
            ui.tradeForm.reset();
            document.getElementById('trade-id').value = '';
            document.getElementById('form-title').textContent = 'Catat Trade Baru';
            document.getElementById('submit-btn').textContent = 'Simpan Trade';
            document.getElementById('cancel-edit-btn').classList.add('hidden');
        }
        
        function populateTradeFormForEdit(tradeId) {
            const trade = allTrades.find(t => t.id === tradeId);
            if (!trade) return;
            document.getElementById('trade-id').value = trade.id;
            document.getElementById('pair').value = trade.pair;
            document.getElementById('lot-size').value = trade.lotSize;
            document.getElementById('strategy').value = trade.strategy;
            document.getElementById('position').value = trade.position;
            document.getElementById('profit-loss').value = trade.pl;
            document.getElementById('notes').value = trade.notes;
            document.getElementById('form-title').textContent = 'Edit Trade';
            document.getElementById('submit-btn').textContent = 'Update Trade';
            document.getElementById('cancel-edit-btn').classList.remove('hidden');
            document.getElementById('trade-form-card').scrollIntoView({ behavior: 'smooth' });
        }
        
        async function deleteTrade(id) {
            if (!activeAccountId || !await showConfirmation('Apakah Anda yakin ingin menghapus data ini?')) return;
            const tradesPath = `users/${auth.currentUser.uid}/accounts/${activeAccountId}/trades`;
            try { await deleteDoc(doc(db, tradesPath, id)); }
            catch (error) { console.error("Error deleting trade:", error); }
        }
        
        function openWithdrawalModal(accountId) {
            ui.withdrawalForm.dataset.accountId = accountId;
            ui.withdrawalModal.classList.remove('hidden');
        }

        async function handleWithdrawalSubmit(e) {
            e.preventDefault();
            const accountId = e.target.dataset.accountId;
            const amount = parseFloat(document.getElementById('withdrawal-amount').value);

            if (!accountId || isNaN(amount) || amount <= 0) {
                showAlert("Jumlah penarikan tidak valid.");
                return;
            }

            const withdrawalData = {
                pair: "WITHDRAWAL",
                lotSize: 0,
                strategy: "Penarikan Dana",
                position: "wd",
                pl: -amount, // Store as a negative value
                notes: `Penarikan sejumlah ${amount}`,
                createdAt: serverTimestamp(),
            };

            const tradesPath = `users/${auth.currentUser.uid}/accounts/${accountId}/trades`;
            try {
                await addDoc(collection(db, tradesPath), withdrawalData);
                ui.withdrawalForm.reset();
                ui.withdrawalModal.classList.add('hidden');
                showAlert("Penarikan dana berhasil dicatat.", "success");
            } catch (error) {
                console.error("Error saving withdrawal:", error);
                showAlert("Gagal mencatat penarikan.");
            }
        }


        function renderTrades() {
            const logBody = document.getElementById('trade-log-body');
            logBody.innerHTML = '';
            if (allTrades.length === 0) {
                logBody.innerHTML = '<tr><td colspan="5" class="px-4 py-4 text-center text-gray-500">Belum ada data di akun ini.</td></tr>';
                return;
            }
            // sort by date descending for display
            const sortedTrades = [...allTrades].sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));

            sortedTrades.forEach(trade => {
                const row = document.createElement('tr');
                
                if (trade.pair === 'WITHDRAWAL') {
                     row.className = 'border-b bg-yellow-50';
                     const tradeDate = trade.createdAt?.toDate().toLocaleDateString('id-ID') || '...';
                     const amountDisplay = getActiveAccount()?.currency === 'USD' ? `$${(-trade.pl).toFixed(2)}` : `${(-trade.pl).toFixed(2)} sen`;
                     row.innerHTML = `
                        <td class="px-4 py-3">${tradeDate}</td>
                        <td class="px-4 py-3 font-bold text-yellow-700" colspan="2">${trade.strategy}</td>
                        <td class="px-4 py-3 font-bold negative-profit">${amountDisplay}</td>
                        <td class="px-4 py-3 text-center space-x-2">
                             <button data-id="${trade.id}" class="delete-btn text-sm text-red-600 hover:underline">Hapus</button>
                        </td>
                     `;

                } else {
                    row.className = 'border-b hover:bg-gray-50';
                    const plClass = trade.pl >= 0 ? 'positive-profit' : 'negative-profit';
                    const tradeDate = trade.createdAt?.toDate().toLocaleDateString('id-ID') || '...';
                    const plDisplay = getActiveAccount()?.currency === 'USD' ? `$${(trade.pl).toFixed(2)}` : `${(trade.pl).toFixed(2)} sen`;
                    row.innerHTML = `
                        <td class="px-4 py-3">${tradeDate}</td>
                        <td class="px-4 py-3 font-bold">${trade.pair}</td>
                        <td class="px-4 py-3">${trade.position.charAt(0).toUpperCase() + trade.position.slice(1)}</td>
                        <td class="px-4 py-3 font-bold ${plClass}">${plDisplay}</td>
                        <td class="px-4 py-3 text-center space-x-2">
                            <button data-id="${trade.id}" class="edit-btn text-sm text-blue-600 hover:underline">Edit</button>
                            <button data-id="${trade.id}" class="mindset-btn text-sm text-teal-600 hover:underline">✨AI</button>
                            <button data-id="${trade.id}" class="delete-btn text-sm text-red-600 hover:underline">Hapus</button>
                        </td>
                    `;
                }
                logBody.appendChild(row);
            });
            document.querySelectorAll('.edit-btn').forEach(b => b.addEventListener('click', () => populateTradeFormForEdit(b.dataset.id)));
            document.querySelectorAll('.delete-btn').forEach(b => b.addEventListener('click', () => deleteTrade(b.dataset.id)));
            document.querySelectorAll('.mindset-btn').forEach(b => b.addEventListener('click', () => openMindsetAnalysis(b.dataset.id)));
        }

        // --- DASHBOARD & ANALYSIS ---
        function getActiveAccount() {
            return allAccounts.find(acc => acc.id === activeAccountId);
        }

        function updateDashboard() {
            const activeAccount = getActiveAccount();
            if (!activeAccount) {
                 // Clear dashboard if no active account
                 document.getElementById('balance').textContent = 'N/A';
                 document.getElementById('total-pl').textContent = 'N/A';
                 document.getElementById('profit-percentage').textContent = 'N/A';
                 document.getElementById('win-rate').textContent = 'N/A';
                 document.getElementById('total-trades').textContent = '0';
                 return;
            }
            
            const startBalance = activeAccount.startBalance || 0;
            const currency = activeAccount.currency || 'cent';

            const actualTrades = allTrades.filter(t => t.pair !== 'WITHDRAWAL');
            const totalPL = allTrades.reduce((acc, trade) => acc + trade.pl, 0);
            const currentBalance = startBalance + totalPL;
            
            const profitPercentage = startBalance > 0 ? (totalPL / startBalance) * 100 : 0;

            const wins = actualTrades.filter(trade => trade.pl > 0).length;
            const winRate = actualTrades.length > 0 ? (wins / actualTrades.length) * 100 : 0;
            
            const formatCurrency = (amount) => currency === 'USD' ? `$${amount.toFixed(2)}` : `${amount.toFixed(2)} sen`;
            
            document.getElementById('balance').textContent = formatCurrency(currentBalance);
            document.getElementById('total-pl').textContent = formatCurrency(totalPL);
            document.getElementById('total-pl').className = `text-3xl font-extrabold mt-2 ${totalPL >= 0 ? 'positive-profit' : 'negative-profit'}`;
            document.getElementById('profit-percentage').textContent = `${profitPercentage.toFixed(1)}%`;
            document.getElementById('profit-percentage').className = `text-3xl font-extrabold mt-2 ${profitPercentage >= 0 ? 'positive-profit' : 'negative-profit'}`;
            document.getElementById('win-rate').textContent = `${winRate.toFixed(1)}%`;
            document.getElementById('total-trades').textContent = actualTrades.length;
        }

        function updateChart() {
            const activeAccount = getActiveAccount();
            const startBalance = activeAccount?.startBalance || 0;

            if (allTrades.length === 0) {
                 equityChart.data.datasets[0].data = [{x: Date.now(), y: startBalance}];
                 equityChart.options.scales.y.title.text = `Saldo Akun (${activeAccount?.currency || ''})`;
                 equityChart.update();
                 return;
            }
            
            let runningBalance = startBalance;
            const firstTradeTimestamp = (allTrades[0] && allTrades[0].createdAt) ? allTrades[0].createdAt.toDate().getTime() : Date.now();
            const chartData = [{ x: firstTradeTimestamp - (24*60*60*1000), y: startBalance }];
            
            allTrades.forEach(trade => {
                if (trade.createdAt && trade.createdAt.toDate) {
                    runningBalance += trade.pl;
                    chartData.push({ x: trade.createdAt.toDate(), y: runningBalance });
                }
            });

            equityChart.data.datasets[0].data = chartData;
            equityChart.options.scales.y.title.text = `Saldo Akun (${activeAccount?.currency || ''})`;
            equityChart.update();
        }

        function renderPairPerformanceChart() {
            const actualTrades = allTrades.filter(t => t.pair !== 'WITHDRAWAL');
            const data = actualTrades.reduce((acc, trade) => {
                if(!acc[trade.pair]) {
                    acc[trade.pair] = { profit: 0, loss: 0 };
                }
                if (trade.pl > 0) acc[trade.pair].profit += trade.pl;
                else acc[trade.pair].loss += Math.abs(trade.pl);
                return acc;
            }, {});

            const totalProfit = Object.values(data).reduce((sum, item) => sum + item.profit, 0);
            const totalLoss = Object.values(data).reduce((sum, item) => sum + item.loss, 0);

            pairChart.data.labels = ['Total Profit', 'Total Loss'];
            pairChart.data.datasets[0].data = [totalProfit, totalLoss];
            pairChart.update();
        }

        function renderStrategyPerformanceChart() {
            const actualTrades = allTrades.filter(t => t.pair !== 'WITHDRAWAL');
            const data = actualTrades.reduce((acc, trade) => {
                if(!acc[trade.strategy]) acc[trade.strategy] = 0;
                acc[trade.strategy] += trade.pl;
                return acc;
            }, {});

            const sortedStrategies = Object.entries(data).sort((a,b) => b[1] - a[1]);

            strategyChart.data.labels = sortedStrategies.map(item => item[0]);
            strategyChart.data.datasets[0].data = sortedStrategies.map(item => item[1]);
            strategyChart.data.datasets[0].backgroundColor = sortedStrategies.map(item => item[1] > 0 ? '#16a34a' : '#dc2626');
            strategyChart.update();
        }

        // --- RISK CALC & AI ---
        async function callGeminiAPI(prompt, element) {
            element.innerHTML = '<div class="loader"></div>';
            try {
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();
                if (result.candidates && result.candidates[0]?.content?.parts?.[0]) {
                    element.innerHTML = result.candidates[0].content.parts[0].text
                        .replace(/\n/g, '<br>')
                        .replace(/\* \*\*(.*?)\*\*/g, '<h4>$1</h4>') // Bolded headers
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
                        .replace(/\* (.*?)(<br>|$)/g, '<li>$1</li>'); // List items
                } else { throw new Error("Invalid AI response."); }
            } catch (error) {
                 element.innerHTML = `<p class="text-red-500">Gagal mendapatkan respons AI. Error: ${error.message}</p>`;
            }
        }
        
        function handleRiskCalculation() {
            const activeAccount = getActiveAccount();
            if(!activeAccount) { showAlert("Pilih akun aktif terlebih dahulu."); return; }

            const slPips = parseFloat(document.getElementById('stop-loss').value);
            const riskPercent = parseFloat(document.getElementById('risk-percent').value);
            const totalPL = allTrades.reduce((acc, trade) => acc + trade.pl, 0);
            const currentBalance = activeAccount.startBalance + totalPL;

            if (isNaN(slPips) || isNaN(riskPercent) || slPips <= 0 || riskPercent <= 0) return;

            const riskAmount = currentBalance * (riskPercent / 100);
            const pipValuePerLot = 10; // $10 per pip per 1 lot (standard), berlaku juga untuk cent

            const valuePerPip = riskAmount / slPips;
            const recommendedLotSize = valuePerPip / pipValuePerLot;

            let lotDisplay;
            if (activeAccount.currency === 'cent') {
            lotDisplay = recommendedLotSize.toFixed(2) + ' (Cent Lot)';
            } else {
            lotDisplay = recommendedLotSize.toFixed(2) + ' (Std Lot)';
            }

            const riskDisplay = activeAccount.currency === 'cent' ? `${riskAmount.toFixed(2)} sen` : `$${riskAmount.toFixed(2)}`;

            document.getElementById('lot-size-result').textContent = lotDisplay;
            document.getElementById('risk-amount-result').textContent = riskDisplay;
            document.getElementById('risk-result').classList.remove('hidden');
        }
        
        function handleAiRecommendation() {
            const lotSize = document.getElementById('lot-size-result').textContent;
            if(!lotSize) { showAlert("Hitung lot size terlebih dahulu."); return; }
            
            const sl = document.getElementById('stop-loss').value;
            const risk = document.getElementById('risk-percent').value;
            const pairInput = document.getElementById('pair').value || "pasangan mayor";

            const prompt = `Saya trading di akun ${getActiveAccount()?.currency || ''} dengan saldo ${document.getElementById('balance').textContent}. Saya berencana membuka posisi di ${pairInput} dengan risiko ${risk}% dan stop loss ${sl} pips. Kalkulator menyarankan total lot size ${lotSize}. Berdasarkan ini:
1.  Berikan 'sanity check' singkat. Apakah ini rencana manajemen risiko yang masuk akal?
2.  Berikan rekomendasi strategi layering (misal, 2-3 layer) dengan pembagian lot yang sesuai untuk setiap layer (total lot harus sama dengan ${lotSize}) dan berikan saran perkiraan titik entry untuk setiap layer relatif terhadap harga saat ini.
Gunakan format HTML yang jelas.`;
            callGeminiAPI(prompt, document.getElementById('ai-recommendation-result'));
        }

        async function generateOverallAnalysis() {
            const container = document.getElementById('analysis-content');
            const actualTrades = allTrades.filter(t => t.pair !== 'WITHDRAWAL');
            if (actualTrades.length < 3) {
                container.innerHTML = '<p class="text-gray-500">Butuh minimal 3 trade untuk analisis AI.</p>';
                return;
            }
            const tradeHistory = actualTrades.map(t => ({ pair: t.pair, pl: t.pl, strategy: t.strategy, notes: t.notes }));
            const prompt = `Anda adalah mentor trading. Analisis riwayat trading ini. Berikan masukan tajam format poin-poin HTML (<ul><li>). Sertakan juga ringkasan dari trade dengan profit terbesar dan loss terbesar sebagai contoh. Fokus pada: pola profit/loss, strategi/pair terbaik & terburuk, kesalahan psikologis dari catatan, dan 1-2 saran perbaikan terpenting. Data: ${JSON.stringify(tradeHistory)}`;
            callGeminiAPI(prompt, container);
        }

        async function openMindsetAnalysis(tradeId) {
            const trade = allTrades.find(t => t.id === tradeId);
            if (!trade) return;
            const modal = document.getElementById('mindset-modal');
            const modalBody = document.getElementById('mindset-modal-body');
            modal.classList.remove('hidden');
            const prompt = `Anda adalah psikolog trading. Analisis catatan dari satu trade ini: Pair: ${trade.pair}, Profit/Loss: ${trade.pl} ${getActiveAccount()?.currency}, Catatan: "${trade.notes}". Berikan analisis psikologis membangun 1-2 paragraf. Identifikasi bias (FOMO, dll.) dan berikan satu saran konkret.`;
            callGeminiAPI(prompt, modalBody);
        }
        
        // --- NEWS FEATURE ---
        async function fetchNews() {
            ui.newsList.innerHTML = '<div class="loader"></div>';
            const RSS_TO_JSON_API = "https://api.rss2json.com/v1/api.json?rss_url=";
            const investingUrl = encodeURIComponent("https://www.investing.com/rss/news_285.rss");

            try {
                const response = await fetch(RSS_TO_JSON_API + investingUrl);
                if(!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (data.status !== 'ok') throw new Error('Gagal mengambil data berita dari API.');
                
                const items = data.items;
                newsCache = items.map(item => item.title);
                let html = items.map(item => {
                    const title = item.title;
                    const link = item.link;
                    const description = item.description.replace(/<[^>]*>?/gm, '').split('.').slice(0, 2).join('.') + '.';
                    return `
                        <div class="p-3 border-b border-gray-200">
                            <a href="${link}" target="_blank" class="font-bold hover:text-blue-600">${title}</a>
                            <p class="text-xs text-gray-500 mt-1">Investing.com</p>
                            <p class="text-sm text-gray-600 mt-1">${description}</p>
                        </div>
                    `;
                }).join('');
                ui.newsList.innerHTML = html;
            } catch(error) {
                ui.newsList.innerHTML = `<p class="text-red-500">Gagal memuat berita umum. Silakan coba lagi nanti.</p>`;
                console.error("Error fetching general news:", error);
            }
        }
        
        async function fetchForexFactoryNews() {
            // Forex Factory RSS feed is no longer supported.
            // Embed the official Forex Factory calendar widget as a fallback.
            ui.forexFactoryCalendar.innerHTML = `
                <iframe src="https://www.forexfactory.com/calendar.php" 
                    width="100%" height="400" frameborder="0" 
                    style="border:0; min-height:400px; background:white;"
                    title="Forex Factory Economic Calendar"></iframe>
                <p class="text-xs text-gray-500 mt-2">
                    Kalender ekonomi di-embed langsung dari ForexFactory.com. Jika tidak tampil, silakan kunjungi situs resmi.
                </p>
            `;
        }
        
        function handleAiNewsRequest() {
            if(newsCache.length === 0) {
                showAlert("Berita belum dimuat. Silakan tunggu sebentar.");
                return;
            }
            const watchedPairs = document.getElementById('watched-pairs').value || "EUR/USD, GBP/JPY, XAU/USD";
            const newsTitles = newsCache.slice(0, 10).join('. ');
            const prompt = `Anda adalah analis pasar keuangan netral. Berdasarkan berita utama forex berikut: "${newsTitles}". Dan dengan fokus pada pasangan mata uang ini: "${watchedPairs}". Berikan ringkasan sentimen pasar saat ini dalam 2-3 poin singkat (gunakan <ul><li>). Hindari saran beli/jual, fokus hanya pada potensi volatilitas atau arah umum yang diimplikasikan oleh berita.`;
            callGeminiAPI(prompt, ui.aiNewsResult);
        }

        // --- CSV IMPORT/EXPORT ---
        function exportToCSV() {
            const actualTrades = allTrades.filter(t => t.pair !== 'WITHDRAWAL');
            if(actualTrades.length === 0) {
                showAlert("Tidak ada data trade untuk diekspor.");
                return;
            }
            const headers = "pair,lotSize,strategy,position,profit,notes,date";
            const csvRows = [headers];
            actualTrades.forEach(trade => {
                const date = trade.createdAt ? trade.createdAt.toDate().toISOString() : new Date().toISOString();
                const row = [
                    trade.pair,
                    trade.lotSize,
                    `"${trade.strategy.replace(/"/g, '""')}"`,
                    trade.position,
                    trade.pl,
                    `"${trade.notes.replace(/"/g, '""')}"`,
                    date
                ];
                csvRows.push(row.join(','));
            });

            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            const accName = getActiveAccount()?.name.replace(/\s/g, '_') || 'jurnal';
            link.setAttribute("download", `jurnal_${accName}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        // ... (processCSVImport and downloadTemplate functions remain the same) ...

        // --- CUSTOM ALERT & CONFIRMATION ---
        function showAlert(message, type = 'error') {
            const alertBox = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            alertBox.className = `fixed top-5 right-5 ${bgColor} text-white py-2 px-4 rounded-lg shadow-lg text-sm z-[2000]`;
            alertBox.textContent = message;
            document.body.appendChild(alertBox);
            setTimeout(() => {
                alertBox.remove();
            }, 3000);
        }

        function showConfirmation(message) {
            return new Promise(resolve => {
                const overlay = document.createElement('div');
                overlay.className = 'modal-overlay';
                overlay.innerHTML = `
                    <div class="modal-content text-center">
                        <p class="mb-6">${message}</p>
                        <div class="flex justify-center gap-4">
                            <button id="confirm-yes" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700">Ya</button>
                            <button id="confirm-no" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">Tidak</button>
                        </div>
                    </div>`;
                document.body.appendChild(overlay);

                document.getElementById('confirm-yes').onclick = () => {
                    overlay.remove();
                    resolve(true);
                };
                document.getElementById('confirm-no').onclick = () => {
                    overlay.remove();
                    resolve(false);
                };
            });
        }


        // --- EVENT LISTENERS ---
        document.getElementById('cancel-edit-btn').addEventListener('click', resetTradeForm);
        document.getElementById('calculate-risk-btn').addEventListener('click', handleRiskCalculation);
        document.getElementById('ai-recommendation-btn').addEventListener('click', handleAiRecommendation);
        ui.aiNewsBtn.addEventListener('click', handleAiNewsRequest);
        document.getElementById('process-import-btn').addEventListener('click', () => {
            const fileInput = document.getElementById('csv-file-input');
            if (fileInput.files.length > 0) {
                processCSVImport(fileInput.files[0]);
            } else {
                showAlert("Silakan pilih file CSV terlebih dahulu.");
            }
        });
        document.getElementById('download-template-btn').addEventListener('click', (e) => { e.preventDefault(); downloadTemplate(); });
        
        // Modal Listeners
        const modals = document.querySelectorAll('.modal-overlay');
        modals.forEach(modal => {
            const closeBtn = modal.querySelector('.modal-close-btn');
            if (closeBtn) closeBtn.addEventListener('click', () => modal.classList.add('hidden'));
            modal.addEventListener('click', (e) => { 
                if (e.target === modal) modal.classList.add('hidden');
            });
        });
        document.getElementById('donation-fab').addEventListener('click', () => ui.donationModal.classList.remove('hidden'));
        document.getElementById('education-fab').addEventListener('click', () => document.getElementById('education-modal').classList.remove('hidden'));
        
        initializeCharts();
    </script>
</body>
</html>
