<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jurnal Trading Cerdas (Advanced)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #1a3b5d;
            padding-bottom: 80px; /* Space for bottom nav */
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.05), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            transition: all 0.3s ease-in-out;
        }
        .positive-profit { color: #16a34a; }
        .negative-profit { color: #dc2626; }
        .chart-container { position: relative; width: 100%; height: 350px; }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3b82f6;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; backdrop-filter: blur(4px);
        }
        .modal-content {
            background-color: white; padding: 2rem; border-radius: 0.75rem;
            max-width: 550px; width: 90%; position: relative;
            box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
        }
        .modal-close {
            position: absolute; top: 1rem; right: 1rem; cursor: pointer;
            font-size: 1.5rem; line-height: 1; color: #9ca3af;
        }
        .modal-close:hover { color: #1a3b5d; }
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background-color: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex; justify-content: space-around;
            padding: 0.5rem 0;
            z-index: 999;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            color: #6b7280; font-size: 0.75rem;
            padding: 0.25rem 1rem; border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
        }
        .nav-item.active { color: #3b82f6; background-color: #eff6ff; }
        .nav-item svg { width: 24px; height: 24px; margin-bottom: 0.25rem; }
        .fab {
            position: fixed; bottom: 90px; right: 20px;
            background-color: #25D366; color: white;
            width: 60px; height: 60px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 14px rgba(0,0,0,0.25);
            cursor: pointer; transition: transform 0.2s;
            z-index: 1000;
        }
        .fab:hover { transform: scale(1.1); }
    </style>
</head>
<body class="antialiased">

    <!-- Auth Screen -->
    <div id="auth-screen" class="min-h-screen flex flex-col items-center justify-center bg-gray-100">
        <h1 class="text-4xl font-black text-blue-600 mb-4">Selamat Datang!</h1>
        <p class="text-gray-600 mb-8">Login untuk mengakses Jurnal Trading Cerdas Anda.</p>
        <button id="login-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
            <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21.99,12.03c0-0.83-0.07-1.62-0.21-2.38h-9.78v4.51h5.5c-0.24,1.48-0.99,2.73-2.13,3.58v2.96h3.8c2.22-2.04,3.5-5.17,3.5-8.67Z" fill="#4285F4"></path><path d="M12,22c2.72,0,5.01-0.9,6.68-2.44l-3.8-2.96c-0.9,0.6-2.07,0.96-3.48,0.96-2.64,0-4.88-1.78-5.68-4.22H2.99v3.06C4.7,20.06,8.08,22,12,22Z" fill="#34A853"></path><path d="M6.32,13.74c-0.15-0.45-0.24-0.93-0.24-1.44s0.09-0.99,0.24-1.44V7.81H2.99C2.37,9.05,2,10.47,2,12s0.37,2.95,0.99,4.19L6.32,13.74Z" fill="#FBBC05"></path><path d="M12,5.28c1.47,0,2.79,0.52,3.83,1.5l3.38-3.38C17.01,1.52,14.72,0,12,0,8.08,0,4.7,1.94,2.99,4.75L6.32,7.81C7.12,5.36,9.36,5.28,12,5.28Z" fill="#EA4335"></path></svg>
            Login dengan Google
        </button>
    </div>

    <!-- Main App Content -->
    <div id="app-content" class="container mx-auto p-4 md:p-8 hidden">
        <div class="flex justify-between items-center mb-8">
            <h2 id="active-account-name" class="text-2xl font-bold">Pilih Akun</h2>
            <div id="user-info" class="flex items-center gap-2">
                <img id="user-photo" class="w-8 h-8 rounded-full">
                <button id="logout-btn" class="text-sm text-gray-500 hover:text-red-500">Logout</button>
            </div>
        </div>

        <!-- VIEWS -->
        <div id="jurnal-view" class="view">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                 <div id="trade-form-card" class="card">
                    <h2 id="form-title" class="text-2xl font-bold mb-4">Catat Trade Baru</h2>
                    <form id="trade-form" class="space-y-4">
                        <input type="hidden" id="trade-id">
                        <datalist id="pair-list"></datalist>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="pair" class="block text-sm font-medium">Pair</label>
                                <input type="text" id="pair" list="pair-list" placeholder="cth: EUR/USD" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="lot-size" class="block text-sm font-medium">Lot Size</label>
                                <input type="number" id="lot-size" step="0.01" placeholder="cth: 0.01" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <div>
                            <label for="strategy" class="block text-sm font-medium">Setup / Strategi</label>
                            <input type="text" id="strategy" placeholder="cth: Breakout H1" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                             <div>
                                <label for="position" class="block text-sm font-medium">Posisi</label>
                                <select id="position" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="buy">Buy</option>
                                    <option value="sell">Sell</option>
                                </select>
                            </div>
                             <div>
                                <label for="profit-loss" class="block text-sm font-medium">P/L</label>
                                <input type="number" step="any" id="profit-loss" placeholder="cth: 50 atau -25" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <div>
                            <label for="notes" class="block text-sm font-medium">Catatan / Kesalahan</label>
                            <textarea id="notes" rows="3" placeholder="cth: Entry terlalu cepat, FOMO" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                        <div class="flex gap-2">
                            <button type="submit" id="submit-btn" class="flex-grow bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Simpan Trade</button>
                            <button type="button" id="cancel-edit-btn" class="hidden flex-grow bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">Batal</button>
                        </div>
                    </form>
                </div>
                 <div class="card">
                    <h2 class="text-2xl font-bold mb-4">Riwayat Trade</h2>
                    <div class="overflow-x-auto max-h-[450px]">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs uppercase bg-gray-700 text-white sticky top-0">
                                <tr>
                                    <th class="px-4 py-3">Tanggal</th>
                                    <th class="px-4 py-3">Pair</th>
                                    <th class="px-4 py-3">Posisi</th>
                                    <th class="px-4 py-3">P/L</th>
                                    <th class="px-4 py-3 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="trade-log-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="analisa-view" class="view hidden">
            <section id="dashboard" class="mb-8">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 text-center">
                    <div class="card">
                        <h3 class="text-md font-bold text-gray-500">Saldo Akun</h3>
                        <p id="balance" class="text-3xl font-extrabold mt-2">$0.00</p>
                    </div>
                    <div class="card">
                        <h3 class="text-md font-bold text-gray-500">Total P/L</h3>
                        <p id="total-pl" class="text-3xl font-extrabold mt-2">$0.00</p>
                    </div>
                    <div class="card">
                        <h3 class="text-md font-bold text-gray-500">Win Rate</h3>
                        <p id="win-rate" class="text-3xl font-extrabold mt-2">0%</p>
                    </div>
                    <div class="card">
                        <h3 class="text-md font-bold text-gray-500">Total Trades</h3>
                        <p id="total-trades" class="text-3xl font-extrabold mt-2">0</p>
                    </div>
                </div>
            </section>
             <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="card">
                    <h2 class="text-2xl font-bold mb-4">Kurva Ekuitas</h2>
                    <div class="chart-container">
                        <canvas id="equity-curve-chart"></canvas>
                    </div>
                </div>
                 <div class="card">
                    <h2 class="text-2xl font-bold mb-4">Analisis Performa AI</h2>
                    <div id="analysis-content" class="space-y-4 text-sm max-h-[350px] overflow-y-auto"></div>
                </div>
            </div>
        </div>

        <div id="akun-view" class="view hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="card">
                    <h2 class="text-2xl font-bold mb-4">Buat Akun Baru</h2>
                    <form id="account-form" class="space-y-4">
                        <div>
                           <label for="account-name" class="block text-sm font-medium">Nama Akun</label>
                           <input type="text" id="account-name" placeholder="cth: Akun Prop Firm" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="start-balance" class="block text-sm font-medium">Saldo Awal</label>
                                <input type="number" id="start-balance" value="1000" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="currency-type" class="block text-sm font-medium">Tipe Mata Uang</label>
                                <select id="currency-type" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="cent">Cent</option>
                                    <option value="USD">USD</option>
                                </select>
                            </div>
                        </div>
                         <button type="submit" id="create-account-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Buat Akun</button>
                    </form>
                </div>
                <div class="card">
                     <h2 class="text-2xl font-bold mb-4">Daftar Akun Anda</h2>
                     <div id="accounts-list" class="space-y-3 max-h-[300px] overflow-y-auto"></div>
                </div>
                 <div class="md:col-span-2 card">
                    <h2 class="text-2xl font-bold mb-4">Kalkulator Risiko AI</h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                             <div>
                                <label for="risk-percent" class="block text-sm font-medium">Risiko (%)</label>
                                <input type="number" id="risk-percent" value="2" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                            </div>
                             <div>
                                <label for="stop-loss" class="block text-sm font-medium">Stop Loss (pips)</label>
                                <input type="number" id="stop-loss" value="20" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                            </div>
                        </div>
                        <button id="calculate-risk-btn" class="w-full bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600">Hitung Lot Size</button>
                        <div id="risk-result" class="text-center p-4 bg-gray-50 rounded-lg mt-4 hidden">
                           <p class="text-sm text-gray-600">Rekomendasi Lot Size:</p>
                           <p id="lot-size-result" class="text-2xl font-bold text-blue-600"></p>
                           <p class="text-xs text-gray-500 mt-1">Estimasi Risiko: <span id="risk-amount-result"></span></p>
                           <button id="sanity-check-btn" class="mt-2 text-sm text-blue-600 hover:underline">Dapatkan Pemeriksaan Kewajaran dari AI</button>
                           <div id="sanity-check-result" class="text-left text-xs mt-2 p-2 bg-blue-50 border-blue-200 rounded-md"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav id="bottom-nav" class="bottom-nav hidden">
        <button data-view="jurnal-view" class="nav-item active">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>
            Jurnal
        </button>
        <button data-view="analisa-view" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 006 16.5h12A2.25 2.25 0 0020.25 14.25V3.75M3.75 18.75h16.5M12 12.75h.008v.008H12v-.008z" /></svg>
            Analisa
        </button>
        <button data-view="akun-view" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            Akun
        </button>
    </nav>
    
    <!-- Donation FAB -->
    <button id="fab" class="fab hidden" title="Donasi untuk Nabhan via DANA">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path d="M10 3.5a1.5 1.5 0 013 0V4a1 1 0 001 1h1a1 1 0 011 1v3.5a1.5 1.5 0 01-3 0V9.5a.5.5 0 00-.5-.5h-1a.5.5 0 00-.5.5v.5a.5.5 0 01-.5.5h-1a.5.5 0 01-.5-.5v-1a.5.5 0 00-.5-.5H9a.5.5 0 00-.5.5v1a.5.5 0 01-.5.5H7a.5.5 0 01-.5-.5V9.5a.5.5 0 00-.5-.5h-1a.5.5 0 00-.5.5v.5a1.5 1.5 0 01-3 0V6a1 1 0 011-1h1a1 1 0 001-1V3.5z" /><path d="M5.5 11a3.5 3.5 0 11-1 3.337V16.5a.5.5 0 00.5.5h2a.5.5 0 00.5-.5v-2.163A3.5 3.5 0 015.5 11zm9 0a3.5 3.5 0 11-1 3.337V16.5a.5.5 0 00.5.5h2a.5.5 0 00.5-.5v-2.163A3.5 3.5 0 0114.5 11z" /></svg>
    </button>
    
    <!-- Modals -->
    <div id="mindset-modal" class="modal-overlay hidden">
        <div class="modal-content"><span class="modal-close-btn modal-close">&times;</span><h2 class="text-2xl font-bold mb-4">✨ Analisis Mindset AI</h2><div id="mindset-modal-body"></div></div>
    </div>
    <div id="donation-modal" class="modal-overlay hidden">
        <div class="modal-content text-center">
            <span class="modal-close-btn modal-close">&times;</span>
            <h2 class="text-2xl font-bold mb-4">Donasi untuk Kreator</h2>
            <p class="mb-4 text-gray-600">Terima kasih telah menggunakan aplikasi ini. Dukung Nabhan melalui DANA.</p>
            <img src="https://placehold.co/300x300/FFFFFF/000000?text=Scan+QR+DANA" alt="QR Code DANA" class="mx-auto rounded-lg shadow-md mb-4" onerror="this.onerror=null;this.src='https://placehold.co/300x300/CCCCCC/FFFFFF?text=QR+Tidak+Tersedia';">
            <p class="font-semibold">Nabhan Yuzqi Al Mubarok</p>
            <p class="text-lg font-bold text-blue-600">0859 5020 2227</p>
        </div>
    </div>
        
    <footer class="text-center mt-12 py-4">
        <p class="text-sm text-gray-500">Dibuat dengan ❤️ oleh Nabhan</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAk8WhrmqYHmWvcLP5kWh9Fpskbk-7UwU8",
            authDomain: "jurnal-trading-ai.firebaseapp.com",
            projectId: "jurnal-trading-ai",
            storageBucket: "jurnal-trading-ai.firebasestorage.app",
            messagingSenderId: "436443442605",
            appId: "1:436443442605:web:3dae7a44032d63b0e0c524",
            measurementId: "G-SQ9SZEKKWZ"
        };
        const geminiApiKey = "";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let equityChart;
        let activeAccountId = null;
        let allAccounts = [];
        let allTrades = [];
        let tradeListenerUnsubscribe = null;
        let accountListenerUnsubscribe = null;

        const ui = {
            authScreen: document.getElementById('auth-screen'),
            appContent: document.getElementById('app-content'),
            loginBtn: document.getElementById('login-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            bottomNav: document.getElementById('bottom-nav'),
            fab: document.getElementById('fab'),
            views: document.querySelectorAll('.view'),
            navItems: document.querySelectorAll('.nav-item'),
            activeAccountName: document.getElementById('active-account-name'),
            userInfo: document.getElementById('user-info'),
            userPhoto: document.getElementById('user-photo'),
            accountForm: document.getElementById('account-form'),
            accountsList: document.getElementById('accounts-list'),
            tradeForm: document.getElementById('trade-form'),
            pairDataList: document.getElementById('pair-list'),
            donationModal: document.getElementById('donation-modal')
        };
        
        function initializeChart() {
            const ctx = document.getElementById('equity-curve-chart').getContext('2d');
            if (equityChart) equityChart.destroy();
            const gradient = ctx.createLinearGradient(0, 0, 0, 350);
            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.2)');
            gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');
            equityChart = new Chart(ctx, {
                type: 'line',
                data: { datasets: [{ label: 'Saldo', data: [], borderColor: '#3b82f6', backgroundColor: gradient, fill: true, tension: 0.2, pointRadius: 0, pointHitRadius: 10 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { type: 'time', time: { unit: 'day', tooltipFormat: 'PPP' }, ticks: { color: '#1a3b5d' }, grid: { color: '#e5e7eb' } },
                        y: { title: { display: true, text: 'Saldo Akun', color: '#1a3b5d' }, ticks: { color: '#1a3b5d' }, grid: { color: '#e5e7eb', borderDash: [2, 3] } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }
        
        // --- AUTH ---
        ui.loginBtn.addEventListener('click', () => signInWithPopup(auth, provider).catch(error => console.error("Login Gagal:", error)));
        ui.logoutBtn.addEventListener('click', () => signOut(auth).catch(error => console.error("Logout Gagal:", error)));

        onAuthStateChanged(auth, user => {
            if (user) {
                ui.authScreen.classList.add('hidden');
                ui.appContent.classList.remove('hidden');
                ui.bottomNav.classList.remove('hidden');
                ui.fab.classList.remove('hidden');
                ui.userPhoto.src = user.photoURL;
                initAppForUser(user);
            } else {
                ui.authScreen.classList.remove('hidden');
                ui.appContent.classList.add('hidden');
                ui.bottomNav.classList.add('hidden');
                ui.fab.classList.add('hidden');
                if (tradeListenerUnsubscribe) tradeListenerUnsubscribe();
                if (accountListenerUnsubscribe) accountListenerUnsubscribe();
            }
        });

        // --- UI & NAVIGATION ---
        ui.bottomNav.addEventListener('click', (e) => {
            const navItem = e.target.closest('.nav-item');
            if (!navItem) return;
            const viewId = navItem.dataset.view;
            ui.views.forEach(view => view.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            ui.navItems.forEach(item => item.classList.remove('active'));
            navItem.classList.add('active');
        });

        function initAppForUser(user) {
            listenForAccounts(user.uid);
            ui.accountForm.addEventListener('submit', (e) => handleAccountForm(e, user.uid));
            ui.tradeForm.addEventListener('submit', handleTradeFormSubmit);
        }
        
        // --- ACCOUNT MANAGEMENT ---
        function listenForAccounts(userId) {
            const accountsRef = collection(db, 'users', userId, 'accounts');
            if (accountListenerUnsubscribe) accountListenerUnsubscribe();
            accountListenerUnsubscribe = onSnapshot(query(accountsRef, orderBy('name')), snapshot => {
                allAccounts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAccountsList();
                
                const storedAccountId = localStorage.getItem(`activeAccountId_${userId}`);
                const accountExists = allAccounts.some(acc => acc.id === storedAccountId);

                if (accountExists) {
                    setActiveAccount(storedAccountId, userId);
                } else if (allAccounts.length > 0) {
                    setActiveAccount(allAccounts[0].id, userId);
                } else {
                    clearDisplay();
                }
            }, (error) => { console.error("Error listening for accounts:", error) });
        }
        
        async function handleAccountForm(e, userId) {
             e.preventDefault();
             const btn = document.getElementById('create-account-btn');
             btn.disabled = true;
             btn.textContent = 'Membuat...';
             const newAccount = {
                name: document.getElementById('account-name').value,
                startBalance: parseFloat(document.getElementById('start-balance').value),
                currency: document.getElementById('currency-type').value
             };
             try {
                await addDoc(collection(db, 'users', userId, 'accounts'), newAccount);
                ui.accountForm.reset();
             } catch(error) { console.error("Error creating account:", error); }
             finally { btn.disabled = false; btn.textContent = 'Buat Akun'; }
        }

        function setActiveAccount(accountId, userId) {
            activeAccountId = accountId;
            localStorage.setItem(`activeAccountId_${userId}`, accountId);
            renderAccountsList(); // to highlight the active one
            const activeAccount = allAccounts.find(acc => acc.id === accountId);
            if(activeAccount) {
                ui.activeAccountName.textContent = activeAccount.name;
                listenForTrades();
            }
        }

        function renderAccountsList() {
            ui.accountsList.innerHTML = '';
            if (allAccounts.length === 0) {
                ui.accountsList.innerHTML = '<p class="text-gray-500 text-sm">Anda belum memiliki akun. Silakan buat satu.</p>';
                return;
            }
            allAccounts.forEach(acc => {
                const accDiv = document.createElement('div');
                accDiv.className = `p-3 rounded-lg flex justify-between items-center cursor-pointer ${acc.id === activeAccountId ? 'bg-blue-100 border border-blue-400' : 'bg-gray-100'}`;
                accDiv.innerHTML = `
                    <div>
                        <p class="font-bold">${acc.name}</p>
                        <p class="text-sm text-gray-500">Saldo Awal: ${acc.startBalance} ${acc.currency}</p>
                    </div>
                    ${acc.id === activeAccountId ? '<span class="text-xs font-bold text-blue-600">AKTIF</span>' : ''}
                `;
                accDiv.addEventListener('click', () => setActiveAccount(acc.id, auth.currentUser.uid));
                ui.accountsList.appendChild(accDiv);
            });
        }

        function clearDisplay() {
            ui.activeAccountName.textContent = "Buat Akun Baru";
            allTrades = [];
            updateDashboard();
            updateChart();
            renderTrades();
            document.getElementById('analysis-content').innerHTML = '<p class="text-gray-500">Silakan pilih atau buat akun untuk memulai.</p>';
        }

        // --- TRADE MANAGEMENT ---
        function listenForTrades() {
            if (!activeAccountId || !auth.currentUser) return;
            if (tradeListenerUnsubscribe) tradeListenerUnsubscribe();
            
            const tradesRef = collection(db, 'users', auth.currentUser.uid, 'accounts', activeAccountId, 'trades');
            const q = query(tradesRef, orderBy("createdAt", "asc"));

            tradeListenerUnsubscribe = onSnapshot(q, snapshot => {
                allTrades = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateAllUI();
            });
        }
        
        function updateAllUI() {
             renderTrades();
             updateDashboard();
             updateChart();
             generateOverallAnalysis();
             updatePairDataList();
        }

        function updatePairDataList() {
            const uniquePairs = [...new Set(allTrades.map(trade => trade.pair))];
            ui.pairDataList.innerHTML = uniquePairs.map(p => `<option value="${p}"></option>`).join('');
        }

        async function handleTradeFormSubmit(e) {
            e.preventDefault();
            if (!activeAccountId) {
                alert("Pilih atau buat akun terlebih dahulu!");
                return;
            }
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;

            const tradeId = document.getElementById('trade-id').value;
            const tradeData = {
                pair: document.getElementById('pair').value.toUpperCase(),
                lotSize: parseFloat(document.getElementById('lot-size').value),
                strategy: document.getElementById('strategy').value,
                position: document.getElementById('position').value,
                plCents: parseFloat(document.getElementById('profit-loss').value),
                notes: document.getElementById('notes').value,
            };

            const tradesPath = `users/${auth.currentUser.uid}/accounts/${activeAccountId}/trades`;

            try {
                if (tradeId) {
                    submitBtn.textContent = 'Mengupdate...';
                    await updateDoc(doc(db, tradesPath, tradeId), tradeData);
                } else {
                    submitBtn.textContent = 'Menyimpan...';
                    tradeData.createdAt = serverTimestamp();
                    await addDoc(collection(db, tradesPath), tradeData);
                }
            } catch (error) { console.error("Error saving trade:", error); }
            finally { submitBtn.disabled = false; resetTradeForm(); }
        }
        
        function resetTradeForm() {
            ui.tradeForm.reset();
            document.getElementById('trade-id').value = '';
            document.getElementById('form-title').textContent = 'Catat Trade Baru';
            document.getElementById('submit-btn').textContent = 'Simpan Trade';
            document.getElementById('cancel-edit-btn').classList.add('hidden');
        }
        
        function populateTradeFormForEdit(tradeId) {
            const trade = allTrades.find(t => t.id === tradeId);
            if (!trade) return;
            document.getElementById('trade-id').value = trade.id;
            document.getElementById('pair').value = trade.pair;
            document.getElementById('lot-size').value = trade.lotSize;
            document.getElementById('strategy').value = trade.strategy;
            document.getElementById('position').value = trade.position;
            document.getElementById('profit-loss').value = trade.plCents;
            document.getElementById('notes').value = trade.notes;
            document.getElementById('form-title').textContent = 'Edit Trade';
            document.getElementById('submit-btn').textContent = 'Update Trade';
            document.getElementById('cancel-edit-btn').classList.remove('hidden');
            document.getElementById('trade-form-card').scrollIntoView({ behavior: 'smooth' });
        }
        
        async function deleteTrade(id) {
            if (!activeAccountId || !confirm('Apakah Anda yakin?')) return;
            const tradesPath = `users/${auth.currentUser.uid}/accounts/${activeAccountId}/trades`;
            try { await deleteDoc(doc(db, tradesPath, id)); }
            catch (error) { console.error("Error deleting trade:", error); }
        }

        function renderTrades() {
            const logBody = document.getElementById('trade-log-body');
            logBody.innerHTML = '';
            if (allTrades.length === 0) {
                logBody.innerHTML = '<tr><td colspan="5" class="px-4 py-4 text-center text-gray-500">Belum ada trade yang dicatat di akun ini.</td></tr>';
                return;
            }
            allTrades.forEach(trade => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                const plClass = trade.plCents >= 0 ? 'positive-profit' : 'negative-profit';
                const tradeDate = trade.createdAt?.toDate().toLocaleDateString('id-ID') || '...';
                const plDisplay = getActiveAccount()?.currency === 'USD' ? `$${(trade.plCents).toFixed(2)}` : `${trade.plCents.toFixed(2)} sen`;
                row.innerHTML = `
                    <td class="px-4 py-3">${tradeDate}</td>
                    <td class="px-4 py-3 font-bold">${trade.pair}</td>
                    <td class="px-4 py-3">${trade.position.charAt(0).toUpperCase() + trade.position.slice(1)}</td>
                    <td class="px-4 py-3 font-bold ${plClass}">${plDisplay}</td>
                    <td class="px-4 py-3 text-center space-x-2">
                        <button data-id="${trade.id}" class="edit-btn text-sm text-blue-600 hover:underline">Edit</button>
                        <button data-id="${trade.id}" class="mindset-btn text-sm text-teal-600 hover:underline">✨AI</button>
                        <button data-id="${trade.id}" class="delete-btn text-sm text-red-600 hover:underline">Hapus</button>
                    </td>
                `;
                logBody.appendChild(row);
            });
            document.querySelectorAll('.edit-btn').forEach(b => b.addEventListener('click', () => populateTradeFormForEdit(b.dataset.id)));
            document.querySelectorAll('.delete-btn').forEach(b => b.addEventListener('click', () => deleteTrade(b.dataset.id)));
            document.querySelectorAll('.mindset-btn').forEach(b => b.addEventListener('click', () => openMindsetAnalysis(b.dataset.id)));
        }

        // --- DASHBOARD & ANALYSIS ---
        function getActiveAccount() {
            return allAccounts.find(acc => acc.id === activeAccountId);
        }

        function updateDashboard() {
            const activeAccount = getActiveAccount();
            const startBalance = activeAccount?.startBalance || 0;
            const currency = activeAccount?.currency || 'cent';

            const totalPL = allTrades.reduce((acc, trade) => acc + trade.plCents, 0);
            const currentBalance = startBalance + totalPL;
            const wins = allTrades.filter(trade => trade.plCents > 0).length;
            const losses = allTrades.filter(trade => trade.plCents < 0).length;
            const winRate = (wins + losses) > 0 ? (wins / (wins + losses)) * 100 : 0;
            
            const formatCurrency = (amount) => currency === 'USD' ? `$${amount.toFixed(2)}` : `${amount.toFixed(0)} sen`;
            
            document.getElementById('balance').textContent = formatCurrency(currentBalance);
            document.getElementById('total-pl').textContent = formatCurrency(totalPL);
            document.getElementById('total-pl').className = `text-3xl font-extrabold mt-2 ${totalPL >= 0 ? 'positive-profit' : 'negative-profit'}`;
            document.getElementById('win-rate').textContent = `${winRate.toFixed(1)}%`;
            document.getElementById('total-trades').textContent = allTrades.length;
        }

        function updateChart() {
            const activeAccount = getActiveAccount();
            const startBalance = activeAccount?.startBalance || 0;

            if (allTrades.length === 0) {
                 equityChart.data.datasets[0].data = [{x: Date.now(), y: startBalance}];
                 equityChart.options.scales.y.title.text = `Saldo Akun (${activeAccount?.currency || ''})`;
                 equityChart.update();
                 return;
            }
            
            let runningBalance = startBalance;
            const firstTradeTimestamp = (allTrades[0] && allTrades[0].createdAt) ? allTrades[0].createdAt.toDate().getTime() : Date.now();
            const chartData = [{ x: firstTradeTimestamp - (24*60*60*1000), y: startBalance }];
            
            allTrades.forEach(trade => {
                if (trade.createdAt && trade.createdAt.toDate) {
                    runningBalance += trade.plCents;
                    chartData.push({ x: trade.createdAt.toDate(), y: runningBalance });
                }
            });

            equityChart.data.datasets[0].data = chartData;
            equityChart.options.scales.y.title.text = `Saldo Akun (${activeAccount?.currency || ''})`;
            equityChart.update();
        }

        // --- RISK CALC & AI ---
        async function callGeminiAPI(prompt, element) {
            element.innerHTML = '<div class="loader"></div>';
            try {
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();
                if (result.candidates && result.candidates[0]?.content?.parts?.[0]) {
                    element.innerHTML = result.candidates[0].content.parts[0].text.replace(/\n/g, '<br>');
                } else { throw new Error("Invalid AI response."); }
            } catch (error) {
                 element.innerHTML = `<p class="text-red-500">Gagal mendapatkan respons AI. Error: ${error.message}</p>`;
            }
        }
        
        function handleRiskCalculation() {
            const activeAccount = getActiveAccount();
            if(!activeAccount) { alert("Pilih akun aktif terlebih dahulu."); return; }

            const slPips = parseFloat(document.getElementById('stop-loss').value);
            const riskPercent = parseFloat(document.getElementById('risk-percent').value);
            const totalPL = allTrades.reduce((acc, trade) => acc + trade.plCents, 0);
            const currentBalance = activeAccount.startBalance + totalPL;

            if (isNaN(slPips) || isNaN(riskPercent) || slPips <= 0 || riskPercent <= 0) return;

            const riskAmount = currentBalance * (riskPercent / 100);
            const pipValuePerMicroLot = 0.10; 
            const valuePerPip = riskAmount / slPips;
            const recommendedLotSize = valuePerPip / pipValuePerMicroLot / 100;

            const lotDisplay = activeAccount.currency === 'cent' ? (recommendedLotSize * 100).toFixed(2) + ' (Cent Lot)' : recommendedLotSize.toFixed(2) + ' (Std Lot)';
            const riskDisplay = activeAccount.currency === 'cent' ? `${riskAmount.toFixed(2)} sen` : `$${riskAmount.toFixed(2)}`;

            document.getElementById('lot-size-result').textContent = lotDisplay;
            document.getElementById('risk-amount-result').textContent = riskDisplay;
            document.getElementById('risk-result').classList.remove('hidden');
        }
        
        function handleSanityCheck() {
            const prompt = `Saya trading di akun ${getActiveAccount()?.currency || ''} dengan saldo ${document.getElementById('balance').textContent}. Saya berencana membuka posisi di ${document.getElementById('pair').value || 'pair mayor'} dengan risiko ${document.getElementById('risk-percent').value}% dan stop loss ${document.getElementById('stop-loss').value} pips. Kalkulator menyarankan lot size ${document.getElementById('lot-size-result').textContent}. Berikan 'sanity check' singkat. Apakah ini rencana manajemen risiko yang masuk akal?`;
            callGeminiAPI(prompt, document.getElementById('sanity-check-result'));
        }

        async function generateOverallAnalysis() {
            const container = document.getElementById('analysis-content');
            if (allTrades.length < 3) {
                container.innerHTML = '<p class="text-gray-500">Butuh minimal 3 trade untuk analisis AI.</p>';
                return;
            }
            const tradeHistory = allTrades.map(t => ({ pair: t.pair, pl: t.plCents, strategy: t.strategy, notes: t.notes }));
            const prompt = `Anda adalah mentor trading. Analisis riwayat trading ini. Berikan masukan tajam format poin-poin HTML (<ul><li>). Sertakan juga ringkasan dari trade dengan profit terbesar dan loss terbesar sebagai contoh. Fokus pada: pola profit/loss, strategi/pair terbaik & terburuk, kesalahan psikologis dari catatan, dan 1-2 saran perbaikan terpenting. Data: ${JSON.stringify(tradeHistory)}`;
            callGeminiAPI(prompt, container);
        }

        async function openMindsetAnalysis(tradeId) {
            const trade = allTrades.find(t => t.id === tradeId);
            if (!trade) return;
            const modal = document.getElementById('mindset-modal');
            const modalBody = document.getElementById('mindset-modal-body');
            modal.classList.remove('hidden');
            const prompt = `Anda adalah psikolog trading. Analisis catatan dari satu trade ini: Pair: ${trade.pair}, Profit/Loss: ${trade.plCents} ${getActiveAccount()?.currency}, Catatan: "${trade.notes}". Berikan analisis psikologis membangun 1-2 paragraf. Identifikasi bias (FOMO, dll.) dan berikan satu saran konkret.`;
            callGeminiAPI(prompt, modalBody);
        }
        
        // --- EVENT LISTENERS ---
        document.getElementById('cancel-edit-btn').addEventListener('click', resetTradeForm);
        document.getElementById('calculate-risk-btn').addEventListener('click', handleRiskCalculation);
        document.getElementById('sanity-check-btn').addEventListener('click', handleSanityCheck);
        
        // Modal Listeners
        const modals = document.querySelectorAll('.modal-overlay');
        modals.forEach(modal => {
            const closeBtn = modal.querySelector('.modal-close-btn');
            if (closeBtn) closeBtn.addEventListener('click', () => modal.classList.add('hidden'));
            modal.addEventListener('click', (e) => { 
                if (e.target === modal) modal.classList.add('hidden');
            });
        });
        ui.fab.addEventListener('click', () => ui.donationModal.classList.remove('hidden'));
        
        initializeChart();
    </script>
</body>
</html>
